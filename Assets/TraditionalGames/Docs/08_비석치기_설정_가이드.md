# 비석치기 설정 가이드

> **문서 버전:** 1.0  
> **최종 수정일:** 2024-12-10  
> **관련 스크립트:** `BiseokManager.lua`, `BiseokObject.lua`, `ThrowingStone.lua`

---

## 1. 개요

비석치기는 Round 2 게임으로, 플레이어가 돌을 던져 비석을 쓰러뜨리는 게임입니다.

### 게임 규칙

1. 비석 3개 배치
2. 플레이어는 돌을 잡아서 던짐
3. 비석이 일정 각도 이상 기울어지면 **쓰러짐** 판정
4. **2개 이상** 쓰러뜨리면 클리어 → 엔딩으로 전환

---

## 2. Unity 설정

### 2.1 Hierarchy 구조

```
Area_03_Biseok (영역)
├── VivenLuaBehaviour (BiseokManager.lua)
├── StoneSpawnPoint (Transform - 돌 생성 위치)
├── Biseoks
│   ├── Biseok_01 (VivenLuaBehaviour: BiseokObject.lua)
│   ├── Biseok_02 (VivenLuaBehaviour: BiseokObject.lua)
│   └── Biseok_03 (VivenLuaBehaviour: BiseokObject.lua)
├── Goblin (선택)
└── Audio (사운드 소스들)
```

### 2.2 BiseokManager 설정

| 변수명 | 타입 | 설명 | 필수 |
|--------|------|------|------|
| `gameFlowManagerName` | string | GameFlowManager 이름 | 선택 |
| `stageManagerName` | string | StageManager 이름 | 선택 |
| `goblinNPCName` | string | GoblinNPC 이름 | 선택 |
| `goblinObject` | GameObject | 도깨비 오브젝트 | 선택 |
| `biseokObjects` | GameObject[] | 비석 오브젝트 배열 | ✅ 필수 |
| `stoneSpawnPoint` | GameObject | 돌 스폰 위치 | ✅ 필수 |
| `stonePrefab` | GameObject | 돌 프리팹 | ✅ 필수 |
| `successSound` | AudioSource | 성공 사운드 | 선택 |
| `biseokFallSound` | AudioSource | 비석 쓰러짐 사운드 | 선택 |
| `throwSound` | AudioSource | 던지기 사운드 | 선택 |
| `startSound` | AudioSource | 시작 사운드 | 선택 |
| `requiredFallenCount` | number | 클리어에 필요한 비석 수 | 선택 (기본: 2) |
| `fallenAngleThreshold` | number | 쓰러짐 판정 각도 | 선택 (기본: 45) |
| `maxStones` | number | 최대 돌 개수 (0=무제한) | 선택 (기본: 0) |
| `stoneRespawnDelay` | number | 돌 리스폰 대기 시간 | 선택 (기본: 1.5) |

### 2.3 BiseokObject 설정 (개별 비석)

| 변수명 | 타입 | 설명 | 필수 |
|--------|------|------|------|
| `fallParticle` | ParticleSystem | 쓰러짐 파티클 | 선택 |
| `hitParticle` | ParticleSystem | 충돌 파티클 | 선택 |
| `hitSound` | AudioSource | 충돌 사운드 | 선택 |
| `biseokMass` | number | 비석 질량 | 선택 (기본: 10) |
| `startKinematic` | boolean | 처음 Kinematic 상태 시작 | 선택 (기본: false) |

### 2.4 ThrowingStone 설정 (돌 프리팹)

| 변수명 | 타입 | 설명 | 필수 |
|--------|------|------|------|
| `minThrowVelocity` | number | 최소 던지기 속도 | 선택 (기본: 2.0) |
| `throwForceMultiplier` | number | 던지기 힘 배율 | 선택 (기본: 1.5) |
| `lifeTime` | number | 생존 시간 (초) | 선택 (기본: 10) |
| `grabParticle` | ParticleSystem | 잡기 파티클 | 선택 |
| `grabSound` | AudioSource | 잡기 사운드 | 선택 |

---

## 3. 프리팹 설정

### 3.1 비석 프리팹 구조

```
Biseok_01 (GameObject)
├── VivenLuaBehaviour (BiseokObject.lua)
├── MeshFilter + MeshRenderer (비석 외형)
├── BoxCollider 또는 MeshCollider
├── Rigidbody
│   ├── Mass: 10 (무거워야 쉽게 안 넘어감)
│   ├── Use Gravity: ✅
│   └── Is Kinematic: ❌ (또는 스크립트로 제어)
├── HitParticle (ParticleSystem)
└── FallParticle (ParticleSystem)
```

### 3.2 돌 프리팹 구조

```
ThrowingStone (GameObject)
├── VivenLuaBehaviour (ThrowingStone.lua)
├── VivenGrabbableModule ← VR 잡기 필수!
├── VivenRigidbodyControlModule ← 물리 제어
├── VivenGrabbableRigidView ← 시각적 피드백
├── MeshFilter + MeshRenderer (돌 외형)
├── SphereCollider 또는 MeshCollider
├── Rigidbody
│   ├── Mass: 1~2
│   └── Use Gravity: ✅
└── GrabParticle (ParticleSystem)
```

### 3.3 태그 설정

- **비석**: `Biseok` 태그 설정 권장
- **돌**: `Throwable` 태그 설정 권장

---

## 4. 쓰러짐 판정

### 4.1 판정 방식

비석의 X축 또는 Z축 회전이 `fallenAngleThreshold` (기본 45도) 이상이면 쓰러진 것으로 판정합니다.

```
직립 상태:    rotation = (0, 0, 0)
기울어짐:     rotation = (30, 0, 10)  → 아직 안 넘어짐
쓰러짐:       rotation = (60, 0, 0)   → 넘어짐! (60 >= 45)
```

### 4.2 물리 설정 팁

| 파라미터 | 권장값 | 설명 |
|----------|--------|------|
| 비석 Mass | 5~15 | 너무 가벼우면 쉽게 넘어감 |
| 비석 Drag | 0.5~1 | 회전 감속 |
| 비석 Angular Drag | 0.5~1 | 회전 저항 |
| 돌 Mass | 1~3 | 충분한 충격력 필요 |

---

## 5. 게임 흐름

### 5.1 시작 시퀀스

```
1. Area_03_Biseok 활성화 (onEnable)
2. BiseokManager.StartGame() 호출
3. 비석 리셋
4. 도깨비 인트로 대사 (GoblinNPC.PlayRound2IntroSequence)
5. "3개 중 2개를 쓰러뜨리세요!" 자막
6. 첫 번째 돌 생성 (SpawnStone)
```

### 5.2 플레이 중

```
- 플레이어가 돌을 잡음 (VivenGrabbableModule.onGrab → ThrowingStone.onGrab)
- 플레이어가 돌을 던짐 (onRelease → OnThrown)
- 돌이 비석에 충돌 (onCollisionEnter → OnHitByStone)
- BiseokManager가 매 프레임 비석 기울기 체크 (CheckBiseokFallen)
- 기울기 >= 45도 → OnBiseokFallen
- 새 돌 자동 생성 (stoneRespawnDelay 후)
```

### 5.3 클리어 시퀀스

```
1. fallenBiseokCount >= requiredFallenCount
2. BiseokManager.OnGameClear()
3. 성공 사운드 + 햅틱 피드백
4. 도깨비 성공 대사
5. GameFlowManager.TransitionToEnding()
```

---

## 6. API 사용법

### 6.1 BiseokManager API

```lua
-- 게임 상태 확인
biseokManager.IsGameActive()    -- 게임 활성화 여부
biseokManager.IsGameCleared()   -- 클리어 여부
biseokManager.GetStonesThrown() -- 던진 돌 개수
biseokManager.GetFallenCount()  -- 쓰러진 비석 수
biseokManager.GetRequiredCount() -- 클리어 필요 비석 수

-- 게임 제어
biseokManager.StartGame()       -- 게임 시작
biseokManager.StopGame()        -- 게임 중지
biseokManager.RestartGame()     -- 게임 재시작
biseokManager.SpawnStone()      -- 돌 생성

-- 이벤트 (내부 또는 외부에서 호출)
biseokManager.OnStoneThrown(stoneObj) -- 돌 던짐
biseokManager.OnBiseokFallen(biseokObj) -- 비석 쓰러짐
```

### 6.2 BiseokObject API

```lua
-- 상태 확인
biseokObject.IsFallen()      -- 쓰러짐 여부

-- 제어
biseokObject.SetManager(mgr) -- 매니저 설정
biseokObject.ResetBiseok()   -- 비석 리셋
biseokObject.EnablePhysics() -- 물리 활성화
biseokObject.DisablePhysics() -- 물리 비활성화
biseokObject.OnFallen()      -- 쓰러짐 처리

-- 이벤트 (충돌 시)
biseokObject.OnHitByStone(collision) -- 돌에 맞음
```

### 6.3 ThrowingStone API

```lua
-- 상태 확인
throwingStone.IsGrabbed()      -- 잡혀있는지
throwingStone.HasBeenThrown()  -- 던져졌는지

-- 제어
throwingStone.SetManager(mgr)  -- 매니저 설정
throwingStone.ForceThrow(dir, force) -- 수동 던지기 (테스트용)

-- 이벤트 (VivenGrabbableModule에서 호출)
throwingStone.onGrab()         -- 잡았을 때
throwingStone.onRelease()      -- 놓았을 때
```

---

## 7. 디버깅

### 7.1 로그 확인

```
[BiseokManager] Initialized
[BiseokManager] Initializing 3 biseok objects
[BiseokManager] Starting Biseok game
[BiseokManager] Stone spawned
[ThrowingStone] Grabbed
[ThrowingStone] Released
[ThrowingStone] Thrown with velocity: 5.2
[BiseokObject] Hit by stone: Biseok_01
[BiseokManager] Biseok fallen! Count: 1/2
[BiseokManager] Biseok fallen! Count: 2/2
[BiseokManager] Game cleared! Fallen: 2
```

### 7.2 일반적인 문제

| 문제 | 원인 | 해결 방법 |
|------|------|----------|
| 돌을 못 잡음 | VivenGrabbableModule 미추가 | 돌 프리팹에 컴포넌트 추가 |
| 던져도 안 날아감 | Rigidbody 미설정 | Rigidbody 추가, Is Kinematic 해제 |
| 비석이 안 넘어감 | 비석이 너무 무거움 | Mass 줄이기 또는 돌 Mass 늘리기 |
| 쓰러짐 판정 안 됨 | fallenAngleThreshold 너무 높음 | 값 조정 (45~60도 권장) |
| 돌이 계속 안 생김 | stonePrefab 미설정 | Inspector에서 프리팹 할당 |

---

## 8. 확장 가능 기능

- [ ] 던지기 힘 게이지 UI
- [ ] 조준선 (Reticle) 표시
- [ ] 비석별 포인트 시스템
- [ ] 시간 제한 모드
- [ ] 멀티플레이어 경쟁 모드
