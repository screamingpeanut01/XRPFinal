# 엔딩 시스템 설정 가이드

> **문서 버전:** 1.0  
> **최종 수정일:** 2024-12-10  
> **관련 스크립트:** `EndingManager.lua`, `GoblinNPC.lua`, `GameFlowManager.lua`

---

## 1. 개요

엔딩 시스템은 게임 클리어 후 연출을 담당합니다.

### 엔딩 시퀀스 흐름

```
1. 빛 기둥 연출 (클리어 효과)
       ↓
2. 시간문 열림 연출
       ↓
3. 도깨비 등장 & 진심 전달
   "전통이 잊혀져 가는 것이 두려웠다..."
       ↓
4. 배지 지급
   "전통놀이 계승자 배지"
       ↓
5. 단청 붕괴 연출
       ↓
6. 현대 경복궁으로 복귀
   (보따리 상호작용 비활성화)
```

---

## 2. Unity 설정

### 2.1 Hierarchy 구조

```
Area_04_Ending (영역)
├── VivenLuaBehaviour (EndingManager.lua)
├── LightPillar (빛 기둥)
│   ├── MeshFilter + MeshRenderer (Cylinder)
│   └── LightPillarParticle (ParticleSystem)
├── TimeGate (시간문)
│   ├── Gate Model (3D Model)
│   └── TimeGateParticle (ParticleSystem)
├── Badge (배지)
│   ├── BadgeSpawnPoint (Transform - 플레이어 앞)
│   ├── Badge Model (3D Model, 회전)
│   └── BadgeParticle (ParticleSystem)
├── Goblin (도깨비)
│   └── VivenLuaBehaviour (GoblinNPC.lua)
├── DanchengCollapseParticle (ParticleSystem)
└── Audio
    ├── ClearMusic (웅장한 음악)
    ├── BadgeSound (배지 등장음)
    ├── TimeGateSound (문 열리는 소리)
    └── HaegumBGM (해금 BGM)
```

### 2.2 EndingManager 설정

| 변수명 | 타입 | 설명 | 필수 |
|--------|------|------|------|
| `gameFlowManagerName` | string | GameFlowManager 이름 | 선택 |
| `stageManagerName` | string | StageManager 이름 | 선택 |
| `goblinNPCName` | string | GoblinNPC 이름 | 선택 |
| `goblinObject` | GameObject | 도깨비 오브젝트 | ✅ 권장 |
| `lightPillar` | GameObject | 빛 기둥 오브젝트 | 선택 |
| `timeGate` | GameObject | 시간문 오브젝트 | 선택 |
| `badgeObject` | GameObject | 배지 오브젝트 | ✅ 권장 |
| `badgeSpawnPoint` | GameObject | 배지 스폰 위치 | 선택 |
| `lightPillarParticle` | ParticleSystem | 빛 기둥 파티클 | 선택 |
| `timeGateParticle` | ParticleSystem | 시간문 파티클 | 선택 |
| `badgeParticle` | ParticleSystem | 배지 파티클 | 선택 |
| `danchengCollapseParticle` | ParticleSystem | 단청 붕괴 파티클 | 선택 |
| `clearMusic` | AudioSource | 클리어 음악 | 선택 |
| `badgeSound` | AudioSource | 배지 사운드 | 선택 |
| `timeGateSound` | AudioSource | 시간문 사운드 | 선택 |
| `haegumBGM` | AudioSource | 해금 BGM | 선택 |
| `modernSkybox` | Material | 현대 스카이박스 | 선택 |
| `lightPillarDuration` | number | 빛 기둥 연출 시간 | 선택 (기본: 3.0) |
| `timeGateOpenDuration` | number | 시간문 열림 시간 | 선택 (기본: 2.0) |
| `badgeRotationSpeed` | number | 배지 회전 속도 | 선택 (기본: 30) |
| `returnDelay` | number | 복귀 전 대기 시간 | 선택 (기본: 3.0) |

---

## 3. 연출 오브젝트 설정

### 3.1 빛 기둥 (Light Pillar)

**구성:**
- Cylinder 메쉬 (세로로 길게)
- Material: Emission 적용 (밝은 황금색/하얀색)
- ParticleSystem: 위로 올라가는 빛 입자

**애니메이션 (선택):**
- Scale 0 → 1 (솟아오르는 효과)
- Emission 강도 증가

### 3.2 시간문 (Time Gate)

**구성:**
- 문 형태의 3D 모델 (한옥 문 스타일)
- ParticleSystem: 빛나는 테두리 효과

**애니메이션 (선택):**
- 문이 천천히 열리는 애니메이션
- 또는 페이드인 효과

### 3.3 배지 (Badge)

**구성:**
- 3D 배지 모델 (전통문양 디자인)
- 플레이어 얼굴 높이, 1~1.5m 앞에 위치
- 자동 회전 (Y축, 30도/초)

**효과:**
- 등장 시 파티클
- 빛나는 효과 (Emission)

### 3.4 단청 붕괴 파티클

**구성:**
- 여러 색상의 단청 조각들이 흩어지는 효과
- 색상: 빨강, 파랑, 초록, 노랑 (전통 단청 색)
- 중력 영향 받아 아래로 떨어짐

---

## 4. 도깨비 대사 (GoblinNPC 연동)

### 4.1 엔딩 전용 대사 키

| 대사 키 | 내용 | 시간 |
|---------|------|------|
| `ending_truth` | "너를 시험한 이유는 전통이 잊혀져 가는 것이 두려웠기 때문이다..." | 7.0초 |
| `ending_badge` | "이 배지를 가져가라. 너는 이제 전통놀이 계승자다." | 4.0초 |
| `ending_farewell` | "너의 시대에서도 이 놀이를 다시 피워내주길 바란다. 안녕히 가거라." | 5.0초 |

### 4.2 GoblinNPC.PlayEndingSequence()

```lua
-- GoblinNPC가 자동으로 3개 대사를 순서대로 재생
-- 재생 순서: ending_truth → ending_badge → ending_farewell
-- 모든 대사 완료 후 도깨비 퇴장 (Disappear)
```

---

## 5. 게임 흐름

### 5.1 엔딩 진입

```
BiseokManager.OnGameClear()
    ↓
GameFlowManager.TransitionToEnding()
    ↓
Area_04_Ending 활성화
    ↓
EndingManager.onEnable() → StartEndingSequence()
```

### 5.2 현대 복귀

```
EndingManager.ReturnToModern()
    ↓
스카이박스 변경 (현대)
    ↓
GameFlowManager.TransitionToPrologueEnding()
    ↓
BottariTrigger.DisableTrigger()
    ↓
플레이어는 현대 경복궁에서 게임 종료
```

---

## 6. API 사용법

### 6.1 EndingManager API

```lua
-- 상태 확인
endingManager.IsSequenceRunning()   -- 시퀀스 진행 중
endingManager.IsSequenceComplete()  -- 시퀀스 완료

-- 시퀀스 제어
endingManager.StartEndingSequence() -- 시퀀스 시작
endingManager.StopSequence()        -- 시퀀스 중지
endingManager.RestartEnding()       -- 재시작 (디버그)

-- 배지 제어
endingManager.StopBadgeRotation()   -- 배지 회전 중지
endingManager.StartBadgeRotation()  -- 배지 회전 시작

-- 개별 단계 실행 (디버그)
endingManager.DebugPlayPhase("lightPillar")
endingManager.DebugPlayPhase("timeGate")
endingManager.DebugPlayPhase("badge")
endingManager.DebugPlayPhase("collapse")
endingManager.DebugPlayPhase("return")
```

### 6.2 연동된 API

```lua
-- GoblinNPC
goblinNPC.PlayEndingSequence(callback)  -- 엔딩 전체 대사 시퀀스

-- GameFlowManager
gameFlowManager.TransitionToEnding()        -- 엔딩으로 전환
gameFlowManager.TransitionToPrologueEnding() -- 프롤로그로 (게임 완료 상태)

-- BottariTrigger
bottariTrigger.DisableTrigger()  -- 트리거 비활성화 (재시작 방지)
bottariTrigger.ResetBottari()    -- 리셋 (새 게임 시작 시)
```

---

## 7. 디버깅

### 7.1 로그 확인

```
[EndingManager] Initialized
[EndingManager] Area enabled - Starting ending sequence
[EndingManager] Playing light pillar effect
[EndingManager] Playing time gate effect
[GoblinNPC] Starting Ending sequence
[GoblinNPC] Speaking: 너를 시험한 이유는...
[GoblinNPC] Speaking: 이 배지를 가져가라...
[GoblinNPC] Speaking: 너의 시대에서도...
[GoblinNPC] Disappearing...
[EndingManager] Showing badge
[EndingManager] Playing dancheng collapse effect
[EndingManager] Returning to modern Gyeongbokgung
[GameFlowManager] Transitioning to Prologue (ending state)
[BottariTrigger] Trigger disabled (game completed)
```

### 7.2 일반적인 문제

| 문제 | 원인 | 해결 방법 |
|------|------|----------|
| 빛 기둥이 안 보임 | lightPillar 미설정 | Inspector에서 설정 |
| 도깨비 대사 안 나옴 | goblinObject 미연결 | 도깨비 오브젝트 연결 |
| 배지가 안 보임 | badgeObject 미설정 | 배지 오브젝트 설정 |
| 현대로 안 돌아감 | gameFlowManager 미연결 | Managers 오브젝트 확인 |
| 다시 시작 가능 | DisableTrigger 미호출 | 스크립트 연동 확인 |

---

## 8. 확장 가능 기능

- [ ] 크레딧 롤 표시
- [ ] 플레이 통계 (시간, 시도 횟수)
- [ ] 스크린샷 저장
- [ ] 배지 컬렉션 시스템
- [ ] 다시 플레이 옵션
