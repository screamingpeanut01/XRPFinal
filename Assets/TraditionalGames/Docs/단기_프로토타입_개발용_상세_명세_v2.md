# 단기 프로토타입 개발용 상세 명세 v2.0

> **문서 버전:** 2.0  
> **최종 수정일:** 2024-12-10  
> **변경 사항:** 무궁화 꽃이 피었습니다(R1) 제외, 2게임 체제로 변경, VIVEN SDK Lua 스크립팅 기반으로 재작성

---

## 1. 개요

본 문서는 VIVEN VR 플랫폼을 타겟으로 하는 인터랙티브 어드벤처 게임 <경복궁 시간의 놀이문>의 기능적 요구사항을 정의한다.

플레이어는 현대의 경복궁에서 조선시대로 이동하여 **2가지 미니게임(판돌 건너기, 비석치기)**을 클리어하고 복귀해야 한다.

### 변경 사항 (v1.0 → v2.0)

| 항목 | v1.0 | v2.0 |
|------|------|------|
| 게임 수 | 3개 (무궁화, 판돌, 비석) | 2개 (판돌, 비석) |
| 씬 구조 | 6개 개별 씬 | 1개 씬, 5개 영역 |
| 로딩 화면 | 별도 씬 | 제외 (단일 씬 구조) |
| 스크립팅 | C# 기반 설계 | Lua 기반 (VIVEN SDK) |

---

## 2. 시스템 공통

### 2.1. 게임 루프 및 영역 관리

| ID | 기능명 | 상세 설명 | 입/출력 데이터 | 구현 상태 |
|----|--------|----------|---------------|----------|
| **SYS-001** | 영역 전환 관리 | 정해진 순서(프롤로그→타임리프→R1→R2→엔딩)대로 영역을 활성화/비활성화하고 플레이어를 텔레포트한다. | Input: 영역 전환 이벤트<br>Output: SetActive + TeleportPlayer | ✅ 완료 (`GameFlowManager.lua`) |
| **SYS-002** | 게임 오버/리스폰 | 각 라운드에서 탈락 조건 충족 시, 화면 페이드 아웃 후 해당 라운드의 시작 지점(Spawn Point)으로 플레이어를 강제 이동시킨다. | Input: Fall Event<br>Output: Player.Mine.TeleportPlayer | ⬜ TODO |
| **SYS-003** | 페이드 전환 시스템 | 영역 전환 시 UI.FadeOut → 영역 변경 → UI.FadeIn 순서로 연출한다. | Input: 전환 시간 (초)<br>Output: FadeIn/FadeOut 호출 | ✅ 완료 (`GameFlowManager.lua`) |
| **SYS-004** | BGM/SFX 관리 | 영역별 BGM 재생 및 게임 이벤트별 SFX를 관리한다. | Input: 영역 이름 또는 이벤트<br>Output: AudioSource.Play() | ✅ 완료 (`AudioManager.lua`) |

### 2.2. 인터랙션 공통 (VIVEN SDK 기반)

| ID | 기능명 | 상세 설명 | 구현 방식 |
|----|--------|----------|----------|
| **INT-001** | 트리거 존 감지 | 플레이어가 특정 영역에 진입하면 이벤트 발생 | `onTriggerEnter(other)` + Collider 태그 검사 |
| **INT-002** | 그립(Grip) 잡기 | VivenGrabbableModule 컴포넌트를 통한 물체 잡기 | `onGrab()` / `onRelease()` 이벤트 |
| **INT-003** | 플레이어 텔레포트 | 플레이어를 특정 위치로 즉시 이동 | `Player.Mine.TeleportPlayer(position, rotation)` |
| **INT-004** | 햅틱 피드백 | 컨트롤러 진동 피드백 | `XR.StartControllerVibration(isLeft, intensity, duration)` |

---

## 3. 영역별 상세 기능 요구사항

### 3.1. Area_00: 프롤로그 - 현대 경복궁

| ID | 기능명 | 상세 로직 | 구현 상태 |
|----|--------|----------|----------|
| **PRO-001** | 플레이어 스폰 | 게임 시작 시 프롤로그 스폰 포인트로 플레이어 텔레포트 | ✅ 완료 |
| **PRO-002** | 보따리 오브젝트 | 바닥에 보따리 모델 배치, 주변에 파티클(반짝임) Loop 재생 | ✅ 완료 |
| **PRO-003** | 보따리 트리거 | 플레이어가 트리거 존 진입 시 자동 카운트다운 시작 (5→1) | ✅ 완료 (`BottariTrigger.lua`) |
| **PRO-004** | 시간문 개방 | 카운트다운 완료 후 `GameFlowManager.TransitionToTimeleap()` 호출 | ✅ 완료 |

#### Lua 스크립트: `BottariTrigger.lua`

```lua
-- 핵심 로직
function onTriggerEnter(other)
    if IsPlayerController(other.gameObject) and not isCountdownStarted then
        StartCountdown()
    end
end

function StartCountdown()
    isCountdownStarted = true
    -- 5, 4, 3, 2, 1 카운트다운 후 TransitionToTimeleap() 호출
end
```

---

### 3.2. Area_01: 타임리프

| ID | 기능명 | 상세 로직 | 구현 상태 |
|----|--------|----------|----------|
| **TIME-001** | 환경 연출 | 스카이박스 변경 (현대 → 조선), 단청 파티클 재생 | ✅ 구현됨 |
| **TIME-002** | 사운드 연출 | 종소리(bellSound), 바람소리(windSound) 재생 | ✅ 구현됨 |
| **TIME-003** | 도깨비 등장 | 도깨비 오브젝트 SetActive(true), 등장 파티클/애니메이션 | ✅ 구현됨 |
| **TIME-004** | 도깨비 대사 | 대사 오디오 + 자막(StageManager) 출력, 완료 후 Round 1 전환 | ✅ 구현됨 |

#### Lua 스크립트: `TimeleapManager.lua`

```lua
function StartTimeleapSequence()
    -- 1. 환경 연출 (단청 파티클, 스카이박스)
    PlayDanchengEffect()
    coroutine.yield(WaitForSeconds(danchengDuration))
    
    -- 2. 사운드 연출
    PlayTimeleapSounds()
    coroutine.yield(WaitForSeconds(goblinAppearDelay))
    
    -- 3. 도깨비 등장
    ShowGoblin()
    coroutine.yield(WaitForSeconds(1.0))
    
    -- 4. 도깨비 대사
    PlayGoblinDialogue()
    coroutine.yield(WaitForSeconds(goblinDialogueDuration))
    
    -- 5. Round 1 전환
    gameFlowManager.TransitionToRound1()
end
```

---

### 3.3. Area_02: ROUND 1 - 판돌 건너기

*핵심: 랜덤 발판 생성 및 물리 낙하*

| ID | 기능명 | 상세 로직 | 구현 상태 |
|----|--------|----------|----------|
| **R1-001** | 발판 생성기 | 게임 시작 시 10~12단계의 발판 쌍(좌/우)을 생성. 각 단계마다 하나는 [안전], 하나는 [깨짐] 속성을 랜덤 부여 | ⬜ TODO (`PandolManager.lua`) |
| **R1-002** | 안전 발판 | 플레이어가 밟아도(onCollisionEnter) 아무런 변화 없이 지지력 유지 | ✅ 로직 준비됨 (`PlatformStep.lua`) |
| **R1-003** | 깨지는 발판 | 플레이어가 밟는 즉시: 1) SFX 재생 2) 메쉬 비활성화 3) Collider 비활성화 | ✅ 로직 준비됨 (`PlatformStep.lua`) |
| **R1-004** | 낙하 판정 | 플레이어 Y좌표가 FallZone 진입 시 게임 오버 → 시작 지점 리스폰 | ⬜ TODO |
| **R1-005** | 도깨비 힌트 | 게임 시작 시 "직감을 믿어라" 오디오 재생 | ⬜ TODO |
| **R1-006** | 승리 조건 | 마지막 발판 너머 골 존(Goal Zone)에 도달하면 Round 2 전환 | ⬜ TODO |

#### Lua 스크립트: `PlatformStep.lua` (완료)

```lua
-- 핵심 로직
function onCollisionEnter(collision)
    if collision.gameObject.tag == "Player" then
        if not isSafe then
            StartBreaking()  -- 깨지는 발판
        end
    end
end

function BreakPlatform()
    breakSound:Play()       -- 효과음
    breakParticle:Play()    -- 파티클
    meshRenderer.enabled = false   -- 메쉬 숨김
    platformCollider.enabled = false  -- 콜라이더 비활성화
end
```

#### Lua 스크립트: `PandolManager.lua` (TODO)

```lua
-- 필요 기능
function StartGame()
    -- 발판 랜덤 배치
    -- 게임 시작 안내
end

function OnPlatformBreak(platform)
    -- 플레이어 낙하 감지
end

function OnPlayerFall()
    -- 리스폰 처리
end

function OnGoalReached()
    -- 클리어 처리 → Round 2 전환
    gameFlowManager.TransitionToRound2()
end
```

---

### 3.4. Area_03: ROUND 2 - 비석치기

*핵심: 물리 투척 및 비석 쓰러짐 판정*

| ID | 기능명 | 상세 로직 | 구현 상태 |
|----|--------|----------|----------|
| **R2-001** | 비석 배치 | 전방 5~10m 거리에 비석 3개 배치. 각 비석은 Rigidbody 부착 | ⬜ TODO |
| **R2-002** | 돌 집기 | VivenGrabbableModule으로 돌 잡기. 손에서 놓으면 물리 투척 | ⬜ TODO |
| **R2-003** | 투척 물리 | 손 휘두르는 속도에 따라 돌에 힘 적용 (VivenRigidbodyControlModule) | ⬜ TODO |
| **R2-004** | 비석 충돌 판정 | 돌이 비석에 충돌(onCollisionEnter) 시 충격량 계산, 비석 기울기 검사 | ⬜ TODO |
| **R2-005** | 비석 쓰러짐 판정 | 비석 Rotation X 또는 Z가 특정 각도 이상이면 '쓰러짐' 판정 | ⬜ TODO |
| **R2-006** | 클리어 판정 | 3개 중 2개 이상 쓰러지면 성공 → 엔딩 전환 | ⬜ TODO |
| **R2-007** | 햅틱 피드백 | 돌을 잡을 때, 던질 때, 비석 쓰러질 때 컨트롤러 진동 | ⬜ TODO |

#### Lua 스크립트: `ThrowingStone.lua` (TODO)

```lua
---@type VivenGrabbableModule
local grabbableModule = nil

function awake()
    grabbableModule = self:GetComponent("VivenGrabbableModule")
end

function onGrab()
    -- 잡았을 때 햅틱 피드백
    XR.StartControllerVibration(isLeftHand, 0.3, 0.1)
end

function onRelease()
    -- 물리 투척은 VIVEN SDK가 자동 처리
    -- 추가 햅틱 피드백
end
```

#### Lua 스크립트: `BiseokManager.lua` (TODO)

```lua
function StartGame()
    -- 비석 초기화
    -- 던지는 돌 생성
    -- 게임 시작 안내
end

function OnBiseokFallen(biseokIndex)
    -- 비석 쓰러짐 처리
    fallenCount = fallenCount + 1
    if fallenCount >= 2 then
        OnGameClear()
    end
end

function OnGameClear()
    -- 클리어 연출 후 엔딩 전환
    gameFlowManager.TransitionToEnding()
end
```

---

### 3.5. Area_04: 엔딩 (Ending)

| ID | 기능명 | 상세 로직 | 구현 상태 |
|----|--------|----------|----------|
| **END-001** | 클리어 연출 | 비석 클리어 시 중앙에서 빛 기둥 솟아오르는 애니메이션 | ⬜ TODO |
| **END-002** | 도깨비 진심 | 도깨비 재등장, 마지막 대사 재생 ("전통이 잊혀져 가는 것이...") | ⬜ TODO |
| **END-003** | 배지 지급 | 플레이어 시야 앞에 '전통놀이 계승자 배지' 3D 모델 표시 및 회전 | ⬜ TODO |
| **END-004** | 현실 복귀 | 화이트 페이드 아웃 후 프롤로그 영역으로 복귀. 보따리는 상호작용 불가 | ⬜ TODO |

---

## 4. 사운드 시스템 요구사항

| ID | 구분 | 기능명 | 발동 조건 및 내용 | 구현 상태 |
|----|------|--------|------------------|----------|
| **SND-001** | BGM | 영역별 BGM | 영역 전환 시 해당 영역의 BGM Loop 재생 | ✅ 완료 (`AudioManager.lua`) |
| **SND-002** | SFX | 성공/실패 | 라운드 통과 시 긍정적 차임벨, 실패 시 부정적 버저 | ⬜ TODO |
| **SND-003** | SFX | 환경음 | 유리 깨지는 소리, 돌 부딪히는 소리 등 | ⬜ TODO |
| **SND-004** | SFX | 도깨비 대사 | 도깨비 등장/대사 시 음성 재생 | ✅ 연결됨 |

---

## 5. 데이터 테이블 및 변수 구조

### 5.1. GameFlowManager (Global State)

| 변수명 | 타입 | 설명 | 기본값 |
|--------|------|------|--------|
| `currentState` | GameState | 현재 게임 상태 | "Prologue" |
| `fadeTransitionTime` | number | 페이드 전환 시간 (초) | 1.0 |

```lua
---@alias GameState "Prologue" | "Timeleap" | "Round1" | "Round2" | "Ending"
```

### 5.2. PandolManager (Round 1 Settings)

| 변수명 | 타입 | 설명 | 기본값 |
|--------|------|------|--------|
| `platformCount` | int | 발판 단계 수 | 10 |
| `breakDelay` | float | 깨지는 발판 딜레이 (초) | 0.3 |
| `fallThresholdY` | float | 낙하 판정 Y 좌표 | -10 |

### 5.3. BiseokManager (Round 2 Settings)

| 변수명 | 타입 | 설명 | 기본값 |
|--------|------|------|--------|
| `totalBiseok` | int | 비석 총 개수 | 3 |
| `requiredFallen` | int | 클리어에 필요한 쓰러진 비석 수 | 2 |
| `fallenAngleThreshold` | float | 쓰러짐 판정 각도 | 45 |

---

## 6. 필수 프리팹 목록

### 6.1. 공통

| 프리팹명 | 설명 | 필수 컴포넌트 | 상태 |
|----------|------|--------------|------|
| SpawnPoint | 영역별 스폰 포인트 | Transform | ✅ 사용 중 |

### 6.2. 판돌 건너기 (Round 1)

| 프리팹명 | 설명 | 필수 컴포넌트 | 상태 |
|----------|------|--------------|------|
| SafePlatform | 안전 발판 | VObject, Collider, MeshRenderer, PlatformStep.lua | ⬜ TODO |
| BreakingPlatform | 깨지는 발판 | VObject, Collider, MeshRenderer, ParticleSystem, AudioSource, PlatformStep.lua | ⬜ TODO |
| FallZone | 낙하 감지 영역 | BoxCollider (Trigger) | ⬜ TODO |
| GoalZone | 클리어 영역 | BoxCollider (Trigger) | ⬜ TODO |

### 6.3. 비석치기 (Round 2)

| 프리팹명 | 설명 | 필수 컴포넌트 | 상태 |
|----------|------|--------------|------|
| ThrowingStone | 던지는 돌 | VObject, VivenGrabbableModule, VivenRigidbodyControlModule, VivenGrabbableRigidView, ThrowingStone.lua | ⬜ TODO |
| Biseok | 비석 | VObject, Rigidbody, Collider | ⬜ TODO |

---

## 7. 구현 우선순위

### Phase 1: 완료됨 ✅
1. 프로젝트 구조 설정
2. GameFlowManager.lua - 게임 흐름 관리
3. StageManager.lua - 자막/UI 관리
4. AudioManager.lua - 사운드 관리
5. BottariTrigger.lua - 보따리 상호작용
6. TimeleapManager.lua - 타임리프 연출
7. PlatformStep.lua - 개별 발판 동작

### Phase 2: 현재 목표 🎯
1. 현대 경복궁 3D 환경 완성
2. 타임리프 파티클/사운드 연출 완성
3. 도깨비 모델 배치 및 GoblinNPC 시스템

### Phase 3: 다음 목표 ⏭️
1. PandolManager.lua - 판돌 건너기 게임 로직
2. 발판 프리팹 생성 및 배치
3. FallZone/GoalZone 설정

### Phase 4: 이후 목표 📋
1. BiseokManager.lua - 비석치기 게임 로직
2. ThrowingStone.lua - 돌 던지기
3. 비석 물리 및 쓰러짐 판정

### Phase 5: 통합 및 QA
1. 엔딩 연출
2. 전체 플로우 테스트
3. 최적화 및 빌드

---

## 8. VIVEN SDK 기술 참고

### 8.1. Lua 스크립트 기본 패턴

```lua
--region Injection
local _INJECTED_ORDER = 0
local function checkInject(OBJECT)
    _INJECTED_ORDER = _INJECTED_ORDER + 1
    assert(OBJECT, _INJECTED_ORDER .. "th object is missing")
    return OBJECT
end
local function NullableInject(OBJECT)
    _INJECTED_ORDER = _INJECTED_ORDER + 1
    if OBJECT == nil then
        Debug.Log(_INJECTED_ORDER .. "th object is missing (nullable)")
    end
    return OBJECT
end

---@type GameObject
TargetObject = checkInject(TargetObject)
--endregion
```

### 8.2. 코루틴 사용

```lua
local util = require 'xlua.util'

self:StartCoroutine(util.cs_generator(function()
    coroutine.yield(WaitForSeconds(1.0))
    -- 1초 후 실행
end))
```

### 8.3. 플레이어 텔레포트

```lua
Player.Mine.TeleportPlayer(spawnPoint.position, spawnPoint.rotation)
```

### 8.4. 햅틱 피드백

```lua
-- 컨트롤러 진동
XR.StartControllerVibration(false, 0.6, 0.1)  -- 오른손
XR.StartControllerVibration(true, 0.1, 0.1)   -- 왼손
```

---

## 9. 변경 이력

| 버전 | 날짜 | 변경 내용 |
|------|------|----------|
| v1.0 | 2024-12-17 | 초기 작성 (3게임 체제, C# 기반) |
| v2.0 | 2024-12-10 | 무궁화 꽃이 피었습니다 제외, 2게임 체제로 변경 |
| | | 씬 기반 → 단일 씬 영역 기반으로 변경 |
| | | VIVEN SDK Lua 스크립팅 기반으로 재작성 |
| | | 현재 구현 상태 반영 |
| | | 프리팹 목록 및 우선순위 추가 |
